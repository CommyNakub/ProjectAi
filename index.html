<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สมุดบัญชี</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --mint: #4fd1c5; 
            --rose: #fb7185; 
            --bg-main: #121212; 
            --card-bg: #1e1e1e; 
            --item-bg: #252525; 
            --border-soft: #333333; 
            --theme-color: var(--mint);
        }
        
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: var(--bg-main); 
            color: #ffffff; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh; 
            margin: 0; 
            overflow-x: hidden;
            transition: background-color 0.4s ease;
        }

        body.expense-mode { --theme-color: var(--rose); }

        .app-container { width: 100%; max-width: 420px; }

        .card-main { 
            background-color: var(--card-bg); 
            border: 1px solid #333; 
            border-radius: 28px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: all 0.4s ease;
        }

        .transaction-item {
            background-color: var(--item-bg);
            border: 1px solid #3a3a3a;
            border-radius: 18px;
            transition: all 0.2s ease;
        }
        .transaction-item:hover { border-color: #555; }

        .balance-text { 
            font-size: 2.6rem; 
            line-height: 1.1; 
            font-weight: 700; 
            letter-spacing: -0.02em; 
            word-break: break-word; 
            max-width: 100%;
            display: inline-block;
            transition: color 0.4s ease;
        }
        
        .input-style { 
            background: #2a2a2a; 
            border: 1px solid var(--border-soft); 
            color: #fff; 
            font-size: 16px !important; 
            border-radius: 16px; 
            padding: 0.8rem; 
            font-weight: 400 !important;
            transition: border-color 0.3s ease;
        }

        /* บังคับไม่ให้ Autofill เปลี่ยนสีพื้นหลังของ Input */
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus, 
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #2a2a2a inset !important; /* สีเทาเข้มเดียวกับ .input-style */
            -webkit-text-fill-color: white !important; /* บังคับสีตัวอักษรเป็นสีขาว */
            transition: background-color 5000s ease-in-out 0s;
        }

        /* กรณีหน้า รายจ่าย ให้ตัวเลขเป็นสีแดงตามเดิมแม้จะเป็น Autofill */
        #expAmount:-webkit-autofill {
            -webkit-text-fill-color: #fb7185 !important;
        }

        /* กรณีหน้า รายรับ ให้ตัวเลขเป็นสีเขียวตามเดิมแม้จะเป็น Autofill */
        #incAmount:-webkit-autofill {
            -webkit-text-fill-color: #4fd1c5 !important;
        }
        
        .input-style::placeholder { font-weight: 400 !important; opacity: 0.6; }
        .input-style:focus { border-color: #555; outline: none; background: #333; }
        
        #form-expense .input-style:focus {
            border-color: var(--border-soft) !important;
            border-width: 1px !important;
        }

        /* เพิ่มคลาสสีแดงเข้มสำหรับข้อความแจ้งเตือนความผิดพลาด */
        .text-error-heavy { color: #dc2626 !important; font-weight: 600; }

        .input-error { border-color: var(--rose) !important; color: var(--rose) !important; }

        .btn-action { transition: all 0.2s; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-action:active { transform: scale(0.96); }
        .btn-disabled { opacity: 0.2; cursor: not-allowed; pointer-events: none; }

        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .theme-transition {
            transition: color 0.4s ease, background-color 0.4s ease, border-color 0.4s ease;
        }

        @media (max-width: 380px) {
            .balance-text { font-size: 2.2rem; }
            .input-style#incAmount::placeholder, 
            .input-style#expAmount::placeholder {
                content: "จำนวนเงิน (สูงสุด 2แสน)";
            }
        }
    </style>
</head>
<body class="px-4">

    <div class="app-container py-6">
        <header class="flex justify-between items-center mb-6 px-1">
            <h1 class="text-2xl font-bold text-white tracking-tight theme-transition">สมุด<span id="brand-accent" class="text-teal-400 theme-transition">บัญชี</span></h1>
            <button onclick="clearHistory()" class="text-zinc-400 text-xs font-medium border border-zinc-700 px-3 py-1.5 rounded-full hover:text-rose-400 hover:border-rose-400 transition-colors">ล้างประวัติ</button>
        </header>

        <div class="card-main p-7 mb-6">
            <div class="text-center">
                <p class="text-zinc-500 text-xs mb-2 font-medium uppercase tracking-[0.15em]">ยอดเงินคงเหลือ</p>
                <h2 id="balance" class="balance-text mb-6">฿0.00</h2>
            </div>
            
            <div class="pt-5 border-t border-zinc-800/50">
                <div class="flex justify-between items-center mb-3">
                    <div class="min-w-0 pr-2">
                        <p class="text-[11px] text-zinc-500 font-bold uppercase mb-0.5">งบประมาณที่ตั้งไว้</p>
                        <p id="displayBudgetVal" class="text-xl font-bold text-white truncate">฿0.00</p>
                    </div>
                    <button id="btn-edit-budget" onclick="showBudgetInput()" class="shrink-0 bg-zinc-800 text-teal-400 px-4 py-2 rounded-xl text-xs font-bold border border-zinc-700 btn-action hover:bg-zinc-700 theme-transition">แก้ไขวงเงิน</button>
                </div>
                <div class="w-full bg-black/30 h-3 rounded-full overflow-hidden mb-2.5">
                    <div id="budgetBar" class="bg-teal-400 h-full transition-all duration-700" style="width: 0%"></div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs text-zinc-400 font-medium">ใช้ไป <span id="budgetPercent" class="text-teal-400 font-bold theme-transition">0%</span></span>
                    <span id="budgetAlertText" class="hidden text-rose-500 font-bold text-[11px] animate-pulse">⚠️ งบประมาณเกินกำหนด</span>
                </div>
                
                <div id="budget-input-area" class="hidden mt-4 p-4 bg-black/20 rounded-2xl border border-white/5 fade-in">
                    <div class="flex flex-col gap-2">
                        <div class="flex flex-wrap sm:flex-nowrap gap-2 budget-controls">
                            <input type="text" id="budgetInput" oninput="validateNumericInput(this, 'btn-confirm-budget', 'error-budget')" placeholder="สูงสุด 200,000 บาท" class="input-style flex-1 py-2 text-sm min-w-0">
                            <button id="btn-confirm-budget" onclick="confirmBudget()" class="bg-teal-400 text-black px-5 py-2 rounded-xl font-bold text-sm btn-action theme-transition">บันทึก</button>
                        </div>
                        <p id="error-budget" class="text-[12px] text-error-heavy hidden text-right">* ตั้งได้ไม่เกิน 200,000 บาท</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
            <button onclick="toggleTab('inc')" id="tab-inc" class="btn-action py-3.5 rounded-2xl font-bold text-base bg-teal-400 text-black shadow-lg shadow-teal-900/10 theme-transition">รายรับ</button>
            <button onclick="toggleTab('exp')" id="tab-exp" class="btn-action py-3.5 rounded-2xl font-bold text-base bg-zinc-800 text-rose-400 border border-zinc-700/50 theme-transition">รายจ่าย</button>
        </div>

        <div id="input-container" class="card-main p-6 mb-8">
            <div id="form-income" class="space-y-4 fade-in">
                <input type="text" id="incDesc" placeholder="ชื่อรายการ" class="input-style w-full border-zinc-700">
                <div>
                    <input type="text" id="incAmount" oninput="validateNumericInput(this, 'btn-save-inc', 'error-inc')" placeholder="จำนวนเงิน (ไม่เกิน 200,000)" class="input-style w-full text-teal-400 border-zinc-700">
                    <p id="error-inc" class="text-[12px] text-error-heavy hidden mt-1.5 ml-1">* กรอกได้ไม่เกิน 200,000 บาท</p>
                </div>
                <input type="text" id="incNote" placeholder="คำอธิบาย (เพิ่มเติม)" class="input-style w-full border-zinc-700">
                <button id="btn-save-inc" onclick="addTransaction('income')" class="btn-action w-full bg-teal-400 py-3.5 rounded-xl text-black font-bold text-base theme-transition">บันทึกรายรับ</button>
            </div>

            <div id="form-expense" class="space-y-4 hidden fade-in">
                <input type="text" id="expDesc" placeholder="ชื่อรายการ" class="input-style w-full border-zinc-700">
                <div>
                    <input type="text" id="expAmount" oninput="validateNumericInput(this, 'btn-save-exp', 'error-exp')" placeholder="จำนวนเงิน (ไม่เกิน 200,000)" class="input-style w-full text-rose-400 border-zinc-700">
                    <p id="error-exp" class="text-[12px] text-error-heavy hidden mt-1.5 ml-1">* กรอกได้ไม่เกิน 200,000 บาท</p>
                </div>
                <input type="text" id="expNote" placeholder="คำอธิบาย (เพิ่มเติม)" class="input-style w-full border-zinc-700">
                <button id="btn-save-exp" onclick="addTransaction('expense')" class="btn-action w-full bg-rose-500 py-3.5 rounded-xl text-white font-bold text-base theme-transition">บันทึกรายจ่าย</button>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4 px-1">
            <h3 class="font-bold text-[11px] text-zinc-500 uppercase tracking-widest">รายการล่าสุด</h3>
            <span id="txCount" class="text-[11px] text-zinc-400 bg-zinc-800/80 px-3 py-1 rounded-full border border-zinc-700/50 theme-transition">0 รายการ</span>
        </div>
        
        <div id="list" class="space-y-3.5 pb-20"></div>
    </div>

    <script>
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let currentBudget = parseFloat(localStorage.getItem('budget')) || 0;
        const LIMIT = 200000;

        function formatNumberWithCommas(value) {
            let cleanVal = value.replace(/[^0-9.]/g, '');
            if ((cleanVal.match(/\./g) || []).length > 1) {
                cleanVal = cleanVal.replace(/\.+$/, "");
            }
            if (cleanVal === "") return "";
            const parts = cleanVal.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts.join('.');
        }

        function validateNumericInput(input, btnId, errorId) {
            const rawVal = input.value.replace(/,/g, '');
            const numericVal = parseFloat(rawVal);
            input.value = formatNumberWithCommas(input.value);
            const btn = document.getElementById(btnId);
            const errorMsg = document.getElementById(errorId);

            if (numericVal > LIMIT) {
                input.classList.add('input-error'); btn.classList.add('btn-disabled');
                errorMsg.classList.remove('hidden');
            } else {
                input.classList.remove('input-error'); btn.classList.remove('btn-disabled');
                errorMsg.classList.add('hidden');
            }
        }

        function getCleanValue(id) {
            return parseFloat(document.getElementById(id).value.replace(/,/g, '')) || 0;
        }

        function showBudgetInput() { document.getElementById('budget-input-area').classList.toggle('hidden'); }

        function confirmBudget() {
            const val = getCleanValue('budgetInput');
            if(val > LIMIT) return;
            currentBudget = val;
            localStorage.setItem('budget', currentBudget);
            document.getElementById('budget-input-area').classList.add('hidden');
            document.getElementById('budgetInput').value = "";
            updateUI(false);
        }

        function toggleTab(type) {
            const tabInc = document.getElementById('tab-inc');
            const tabExp = document.getElementById('tab-exp');
            const formInc = document.getElementById('form-income');
            const formExp = document.getElementById('form-expense');
            const brandAccent = document.getElementById('brand-accent');
            const btnEditBudget = document.getElementById('btn-edit-budget');
            const budgetPercent = document.getElementById('budgetPercent');
            const btnConfirmBudget = document.getElementById('btn-confirm-budget');

            if (type === 'inc') {
                document.body.classList.remove('expense-mode');
                tabInc.className = 'btn-action py-3.5 rounded-2xl font-bold text-base bg-teal-400 text-black theme-transition';
                tabExp.className = 'btn-action py-3.5 rounded-2xl font-bold text-base bg-zinc-800 text-rose-400 border border-zinc-700/50 theme-transition';
                brandAccent.className = 'text-teal-400 theme-transition';
                btnEditBudget.classList.replace('text-rose-400', 'text-teal-400');
                budgetPercent.className = 'text-teal-400 font-bold theme-transition';
                formInc.classList.remove('hidden'); formExp.classList.add('hidden');
                
                // คืนค่าปุ่มบันทึกวงเงินเป็นสีเขียว
                btnConfirmBudget.className = 'bg-teal-400 text-black px-5 py-2 rounded-xl font-bold text-sm btn-action theme-transition';
            } else {
                document.body.classList.add('expense-mode');
                tabExp.className = 'btn-action py-3.5 rounded-2xl font-bold text-base bg-rose-500 text-white shadow-lg shadow-rose-900/10 theme-transition';
                tabInc.className = 'btn-action py-3.5 rounded-2xl font-bold text-base bg-zinc-800 text-teal-400 border border-zinc-700/50 theme-transition';
                brandAccent.className = 'text-rose-400 theme-transition';
                btnEditBudget.classList.replace('text-teal-400', 'text-rose-400');
                budgetPercent.className = 'text-rose-400 font-bold theme-transition';
                formExp.classList.remove('hidden'); formInc.classList.add('hidden');
                
                // เปลี่ยนปุ่มบันทึกวงเงินเป็นสีแดง (เมื่ออยู่ในหน้าจ่าย)
                btnConfirmBudget.className = 'bg-rose-500 text-white px-5 py-2 rounded-xl font-bold text-sm btn-action theme-transition';
            }
            updateStatsOnly();
        }

        function addTransaction(type) {
            const desc = type === 'income' ? document.getElementById('incDesc') : document.getElementById('expDesc');
            const amountId = type === 'income' ? 'incAmount' : 'expAmount';
            const note = type === 'income' ? document.getElementById('incNote') : document.getElementById('expNote');
            const amountVal = getCleanValue(amountId);
            if (!desc.value || isNaN(amountVal) || amountVal <= 0 || amountVal > LIMIT) return;
            
            transactions.unshift({
                id: Date.now(),
                text: desc.value,
                amount: type === 'income' ? amountVal : -amountVal,
                note: note.value,
                date: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            });
            localStorage.setItem('transactions', JSON.stringify(transactions));
            desc.value = ''; document.getElementById(amountId).value = ''; note.value = '';
            updateUI(true);
        }

        function removeTransaction(id) {
            if(!confirm('ยืนยันการลบรายการนี้หรือไม่')) return;
            transactions = transactions.filter(t => t.id !== id);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            updateUI(true);
        }

        function clearHistory() {
            if(!confirm('ยืนยันการลบข้อมูลทั้งหมด')) return;
            transactions = [];
            localStorage.setItem('transactions', JSON.stringify(transactions));
            updateUI(true);
        }

        function updateStatsOnly() {
            const total = transactions.reduce((acc, item) => acc + item.amount, 0);
            const expenseTotal = Math.abs(transactions.filter(t => t.amount < 0).reduce((acc, t) => acc + t.amount, 0));
            const balanceEl = document.getElementById('balance');
            balanceEl.innerText = `฿${total.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            balanceEl.className = `balance-text mb-6 ${total < 0 ? 'text-rose-400' : 'text-white'}`;
            document.getElementById('displayBudgetVal').innerText = `฿${currentBudget.toLocaleString()}`;
            
            const bar = document.getElementById('budgetBar');
            const isExpMode = document.body.classList.contains('expense-mode');
            if (currentBudget > 0) {
                const percent = Math.round((expenseTotal / currentBudget) * 100);
                bar.style.width = `${Math.min(percent, 100)}%`;
                document.getElementById('budgetPercent').innerText = `${percent}%`;
                document.getElementById('budgetAlertText').classList.toggle('hidden', percent <= 100);
                if (percent > 100) bar.style.backgroundColor = '#fb7185';
                else bar.style.backgroundColor = isExpMode ? '#fb7185' : '#4fd1c5';
            } else {
                bar.style.width = '0%';
                document.getElementById('budgetPercent').innerText = '0%';
            }
        }

        function updateUI(shouldRenderList = true) {
            updateStatsOnly();
            if (!shouldRenderList) return;
            const list = document.getElementById('list');
            list.innerHTML = '';
            document.getElementById('txCount').innerText = `${transactions.length} รายการ`;
            transactions.forEach(t => {
                const isInc = t.amount > 0;
                const div = document.createElement('div');
                div.className = `transaction-item flex justify-between items-center p-4 shadow-sm fade-in ${!isInc ? 'border-zinc-800' : ''}`;
                div.innerHTML = `
                    <div class="flex items-center gap-4 overflow-hidden pr-2">
                        <div class="w-10 h-10 shrink-0 rounded-full flex items-center justify-center font-bold text-[20px] ${isInc ? 'bg-teal-400/10 text-teal-400' : 'bg-rose-500/10 text-rose-400'}">
                            ${isInc ? '⬈' : '⬊'}
                        </div>
                        <div class="overflow-hidden">
                            <p class="text-[15px] font-semibold truncate text-white">${t.text}</p>
                            <p class="text-[10px] text-zinc-500 font-medium">${t.note || t.date}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 shrink-0">
                        <span class="text-[16px] font-bold ${isInc ? 'text-teal-400' : 'text-rose-400'}">
                            ${isInc ? '+' : '-'}฿${Math.abs(t.amount).toLocaleString()}
                        </span>
                        <button onclick="removeTransaction(${t.id})" class="text-zinc-500 hover:text-rose-400 px-2 py-1 text-2xl leading-none transition-colors ml-1">×</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }
        updateUI();
    </script>
</body>
</html>
